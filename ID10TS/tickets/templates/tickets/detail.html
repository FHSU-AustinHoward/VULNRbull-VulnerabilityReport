{% extends 'tickets/base.html' %}

{% block title %}Ticket Detail{% endblock %}

{% block content %}
    <!-- Ticket Detail -->
    <div class="card">
        <div class="card-header">
            <h2>Ticket Detail</h2>
        </div>
        <div class="card-body">
            <table class="table">
                <tbody>
                    <tr>
                        <th>Ticket #</th>
                        <td>{{ ticket.id }}</td>
                    </tr>
                    <tr>
                        <th>Title</th>
                        <td>{{ ticket.title }}</td>
                    </tr>
                    <tr>
                        <th>Date Opened</th>
                        <td>{{ ticket.date_opened|date:"F j, Y, P" }}</td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td>{{ ticket.status }}</td>
                    </tr>
                    <tr>
                        <th>Category</th>
                        <td>{{ ticket.ticket_category }}</td>
                    </tr>
                    <tr>
                        <th>Priority</th>
                        <td>{{ ticket.priority }}</td>
                    </tr>
                    <tr>
                        <th>Assigned to</th>
                        <td>{{ ticket.assigned_to }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="card mt-4">
        <div class="card-header">
            <h2>Comments</h2>
        </div>
        <div class="card-body" id="comments-section">
            <ul class="list-group">
                {% for comment in comments %}
                    <li class="list-group-item">{{ comment.message }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

<!-- Add Comment Button and Modal -->
<button id="show-modal-button" class="btn btn-primary mt-4">Add Comment</button>

<!-- Modal -->
<div id="comment-modal" class="modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Comment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="comment-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="id_message">Comment:</label>
                        <textarea id="id_message" name="message" class="form-control" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function() {
        console.log("Document is ready");

        // Show modal when Add Comment button is clicked
        $('#show-modal-button').click(function(event) {
            event.preventDefault();
            console.log("Add Comment button clicked");
            $('#comment-modal').modal('show');
        });

        // Handle form submission
        $('#comment-form').submit(function(event) {
            event.preventDefault(); // Prevent default form submission
            console.log("Form submitted");

            // Get form data
            let formData = $(this).serialize();
            console.log("Form data:", formData);

            // Get the ticket ID
            let ticketId = {{ ticket.pk }};
            console.log("Ticket ID:", ticketId);

            // Send AJAX request
            $.ajax({
                url: window.location.pathname,  // Send the request to the current URL
                method: 'POST',
                data: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log("AJAX request successful");
                    // Comment added successfully, update UI as needed
                    $('#comment-modal').modal('hide'); // Hide the modal
                    // Optionally, update the comments list without refreshing the page
                    $('#comments-section').html(response); // Assuming response contains updated comments HTML
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    // Handle error response
                }
            });

        });
    });
</script>

{% endblock %}
